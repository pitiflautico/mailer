# Nginx Configuration for Shared Server with Multiple Projects
#
# Este ejemplo muestra cómo configurar múltiples proyectos en el mismo servidor.
# Cada proyecto tiene su propio bloque server con su dominio y configuración.

# ===================================================================
# PROJECT 1: MailCore (mail.tudominio.com)
# ===================================================================

server {
    listen 80;
    listen [::]:80;
    server_name mail.tudominio.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name mail.tudominio.com;

    root /var/www/mailcore/public;
    index index.php index.html;

    ssl_certificate /etc/letsencrypt/live/mail.tudominio.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mail.tudominio.com/privkey.pem;

    access_log /var/log/nginx/mailcore-access.log;
    error_log /var/log/nginx/mailcore-error.log;

    client_max_body_size 50M;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000" always;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_read_timeout 300;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}

# ===================================================================
# PROJECT 2: Another Laravel App (app.tudominio.com)
# ===================================================================

server {
    listen 80;
    listen [::]:80;
    server_name app.tudominio.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name app.tudominio.com;

    root /var/www/another-app/public;
    index index.php index.html;

    ssl_certificate /etc/letsencrypt/live/app.tudominio.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.tudominio.com/privkey.pem;

    access_log /var/log/nginx/app-access.log;
    error_log /var/log/nginx/app-error.log;

    client_max_body_size 20M;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}

# ===================================================================
# PROJECT 3: Static Website (www.tudominio.com)
# ===================================================================

server {
    listen 80;
    listen [::]:80;
    server_name www.tudominio.com tudominio.com;
    return 301 https://www.tudominio.com$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.tudominio.com tudominio.com;

    root /var/www/website/public;
    index index.html index.htm;

    ssl_certificate /etc/letsencrypt/live/www.tudominio.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.tudominio.com/privkey.pem;

    access_log /var/log/nginx/website-access.log;
    error_log /var/log/nginx/website-error.log;

    location / {
        try_files $uri $uri/ =404;
    }

    # Cache static files
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}

# ===================================================================
# PROJECT 4: WordPress Site (blog.tudominio.com)
# ===================================================================

server {
    listen 80;
    listen [::]:80;
    server_name blog.tudominio.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name blog.tudominio.com;

    root /var/www/wordpress;
    index index.php index.html;

    ssl_certificate /etc/letsencrypt/live/blog.tudominio.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/blog.tudominio.com/privkey.pem;

    access_log /var/log/nginx/blog-access.log;
    error_log /var/log/nginx/blog-error.log;

    client_max_body_size 100M;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)$ {
        expires max;
        log_not_found off;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}

# ===================================================================
# PROJECT 5: API Service (api.tudominio.com)
# ===================================================================

server {
    listen 80;
    listen [::]:80;
    server_name api.tudominio.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.tudominio.com;

    root /var/www/api/public;
    index index.php index.html;

    ssl_certificate /etc/letsencrypt/live/api.tudominio.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.tudominio.com/privkey.pem;

    access_log /var/log/nginx/api-access.log;
    error_log /var/log/nginx/api-error.log;

    # CORS Headers for API
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

    location / {
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Authorization, Content-Type";
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }

        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}

# ===================================================================
# NOTES:
# ===================================================================
#
# 1. Cada proyecto debe tener su propio bloque server
# 2. Usa dominios únicos o subdominios para cada proyecto
# 3. Los certificados SSL se gestionan por separado para cada dominio
# 4. Los logs se separan por proyecto para mejor trazabilidad
# 5. Cada proyecto puede tener configuraciones específicas (client_max_body_size, etc.)
#
# Para activar estas configuraciones:
#   sudo ln -s /etc/nginx/sites-available/ARCHIVO.conf /etc/nginx/sites-enabled/
#   sudo nginx -t
#   sudo systemctl reload nginx
#
# Para obtener certificados SSL:
#   sudo certbot --nginx -d dominio.com -d www.dominio.com
#
